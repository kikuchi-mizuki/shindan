import requests
import pandas as pd
import logging
import os
from datetime import datetime

logger = logging.getLogger(__name__)

class PMDADownloader:
    def __init__(self):
        self.base_url = "https://www.pmda.go.jp"
        self.data_dir = "data"
        
        # データディレクトリを作成
        os.makedirs(self.data_dir, exist_ok=True)
    
    def download_drug_data(self):
        """PMDAから薬剤データをダウンロード"""
        try:
            logger.info("PMDAデータのダウンロードを開始します...")
            
            # より大規模なサンプルデータを作成（実際のPMDAデータの構造に近い）
            sample_data = self._create_extended_sample_data()
            
            # 生データを保存
            raw_file = os.path.join(self.data_dir, 'drug_database.csv')
            sample_data.to_csv(raw_file, index=False, encoding='utf-8')
            logger.info(f"サンプルデータを保存しました: {raw_file}")
            
            # データを処理
            processed_data = self._process_drug_data(sample_data)
            
            # 処理済みデータを保存
            processed_file = os.path.join(self.data_dir, 'processed_drug_database.csv')
            processed_data.to_csv(processed_file, index=False, encoding='utf-8')
            logger.info(f"データ処理完了: {len(processed_data)}件")
            logger.info(f"データベース更新完了: {processed_file}")
            
            return processed_data
            
        except Exception as e:
            logger.error(f"データダウンロードエラー: {e}")
            return self._create_fallback_data()
    
    def _create_extended_sample_data(self):
        """拡張されたサンプル薬剤データを作成（100件以上）"""
        # 100件以上の薬剤データ
        sample_data = {
            '販売名': [
                # 解熱鎮痛薬 (20件)
                'アスピリン錠100mg「タイヨー」', 'ワルファリンカリウム錠1mg「サワイ」',
                'ロキソプロフェンナトリウム錠60mg「タイヨー」', 'アセトアミノフェン錠200mg「サワイ」',
                'イブプロフェン錠200mg「タイヨー」', 'ジクロフェナクナトリウム錠25mg「サワイ」',
                'セレコキシブ錠100mg「タイヨー」', 'ナプロキセンナトリウム錠275mg「サワイ」',
                'メフェナム酸錠250mg「タイヨー」', 'インドメタシン錠25mg「サワイ」',
                'ケトプロフェン錠50mg「タイヨー」', 'フェニルブタゾン錠100mg「サワイ」',
                'ピロキシカム錠10mg「タイヨー」', 'メロキシカム錠7.5mg「サワイ」',
                'エトドラク錠200mg「タイヨー」', 'ナブメトン錠500mg「サワイ」',
                'スリンダク錠150mg「タイヨー」', 'テノキシカム錠20mg「サワイ」',
                'アセメタシン錠25mg「タイヨー」', 'オキサプロジン錠200mg「サワイ」',
                
                # 循環器系薬 (15件)
                'ジゴキシン錠0.125mg「タイヨー」', 'アミオダロン塩酸塩錠200mg「サワイ」',
                'シンバスタチン錠5mg「タイヨー」', 'アトルバスタチンカルシウム錠10mg「サワイ」',
                'プラバスタチンナトリウム錠5mg「タイヨー」', 'ロスバスタチンカルシウム錠2.5mg「サワイ」',
                'ピタバスタチンカルシウム錠1mg「タイヨー」', 'フルバスタチンナトリウム錠20mg「サワイ」',
                'ニフェジピン錠10mg「タイヨー」', 'アムロジピンベシル酸塩錠2.5mg「サワイ」',
                'ベラパミル塩酸塩錠40mg「タイヨー」', 'ジルチアゼム塩酸塩錠30mg「サワイ」',
                'カプトプリル錠12.5mg「タイヨー」', 'エナラプリルマレイン酸塩錠2.5mg「サワイ」',
                'ロサルタンカリウム錠25mg「タイヨー」',
                
                # 糖尿病治療薬 (10件)
                'インスリン注射液「ノボラピッド」', 'メトホルミン塩酸塩錠250mg「タイヨー」',
                'グリクラジド錠40mg「サワイ」', 'グリメピリド錠1mg「タイヨー」',
                'ピオグリタゾン塩酸塩錠15mg「サワイ」', 'シタグリプチンリン酸塩錠25mg「タイヨー」',
                'ビルダグリプチン錠50mg「サワイ」', 'リナグリプチン錠5mg「タイヨー」',
                'アログリプチン安息香酸塩錠6.25mg「サワイ」', 'テネリグリプチン臭化水素酸塩錠20mg「タイヨー」',
                
                # 消化器系薬 (15件)
                'オメプラゾール錠20mg「サワイ」', 'ランソプラゾール錠30mg「タイヨー」',
                'ファモチジン錠20mg「サワイ」', 'ラニチジン塩酸塩錠150mg「タイヨー」',
                'メトクロプラミド錠10mg「サワイ」', 'ドンペリドン錠10mg「タイヨー」',
                'プルゼニド錠1mg「サワイ」', 'マグラックス錠10mg「タイヨー」',
                'ピコスルファートナトリウム内用液0.5%「サワイ」', 'センノシド錠12mg「サワイ」',
                'ビサコジル錠5mg「タイヨー」', 'ラクツロース内用液67%「サワイ」',
                'ポリエチレングリコール4000散「タイヨー」', 'スルピリド錠50mg「サワイ」',
                'イトプリド塩酸塩錠50mg「タイヨー」',
                
                # 抗がん剤 (10件)
                'エンドキサン注射用100mg「タイヨー」', 'オンコビン注射用1mg「サワイ」',
                'シスプラチン注射用10mg「タイヨー」', 'カルボプラチン注射用150mg「サワイ」',
                'パクリタキセル注射用30mg「タイヨー」', 'ドセタキセル注射用20mg「サワイ」',
                'イリノテカン塩酸塩注射用40mg「タイヨー」', 'オキサリプラチン注射用50mg「サワイ」',
                'ゲムシタビン塩酸塩注射用200mg「タイヨー」', 'ビノレルビン酒石酸塩注射用10mg「サワイ」',
                
                # 抗リウマチ薬・免疫抑制薬 (10件)
                'メトトレキサート錠2.5mg「タイヨー」', 'プレドニゾロン錠5mg「サワイ」',
                'シクロスポリン錠25mg「タイヨー」', 'タクロリムス錠1mg「サワイ」',
                'アザチオプリン錠25mg「タイヨー」', 'ミコフェノール酸モフェチル錠250mg「サワイ」',
                'レフルノミド錠10mg「タイヨー」', 'サラゾスルファピリジン錠500mg「サワイ」',
                'ブシラミン錠100mg「タイヨー」', 'ペニシラミン錠125mg「サワイ」',
                
                # 抗生物質 (15件)
                'アモキシシリン錠250mg「タイヨー」', 'セファレキシン錠250mg「サワイ」',
                'エリスロマイシン錠200mg「タイヨー」', 'クラリスロマイシン錠200mg「サワイ」',
                'アジスロマイシン錠250mg「タイヨー」', 'ドキシサイクリン塩酸塩錠100mg「サワイ」',
                'ミノサイクリン塩酸塩錠100mg「タイヨー」', 'レボフロキサシン錠100mg「サワイ」',
                'シプロフロキサシン塩酸塩錠100mg「タイヨー」', 'ノルフロキサシン錠100mg「サワイ」',
                'バンコマイシン塩酸塩注射用500mg「タイヨー」', 'テイコプラニン注射用200mg「サワイ」',
                'メロペネム注射用500mg「タイヨー」', 'イミペネム・シラスタチンナトリウム注射用250mg「タイヨー」',
                'セフトリアキソンナトリウム注射用1g「サワイ」',
                
                # 精神神経系薬 (10件)
                'フルオキセチン塩酸塩錠20mg「タイヨー」', 'パロキセチン塩酸塩錠20mg「サワイ」',
                'セルトラリン塩酸塩錠50mg「タイヨー」', 'エスシタロプラムシュウ酸塩錠10mg「サワイ」',
                'ベンラファキシン塩酸塩錠37.5mg「タイヨー」', 'デュロキセチン塩酸塩錠30mg「サワイ」',
                'アリピプラゾール錠3mg「タイヨー」', 'リスペリドン錠1mg「サワイ」',
                'オランザピン錠5mg「タイヨー」', 'クエチアピンフマル酸塩錠25mg「サワイ」',
                
                # 呼吸器系薬 (10件)
                'テオフィリン錠100mg「タイヨー」', 'サルブタモール硫酸塩錠2mg「サワイ」',
                'フォルモテロールフマル酸塩錠40μg「タイヨー」', 'サルメテロールキシナホ酸塩錠50μg「サワイ」',
                'ブデソニド錠0.5mg「タイヨー」', 'フルチカゾンプロピオン酸エステル錠100μg「サワイ」',
                'モンテルカストナトリウム錠5mg「タイヨー」', 'ザフィルルカスト錠20mg「タイヨー」',
                'アセチルシステイン錠200mg「サワイ」', 'カルボシステイン錠250mg「タイヨー」',
                
                # 泌尿器系薬 (10件)
                'フィナステリド錠1mg「タイヨー」', 'デュタステリド錠0.5mg「サワイ」',
                'タムスロシン塩酸塩錠0.2mg「タイヨー」', 'シルドシン錠4mg「サワイ」',
                'ナフトピジル錠25mg「タイヨー」', 'ウラピジル錠30mg「タイヨー」',
                'フロセミド錠20mg「サワイ」', 'スピロノラクトン錠25mg「タイヨー」',
                'ヒドロクロロチアジド錠25mg「サワイ」', 'アミロライド塩酸塩錠5mg「タイヨー」',
                
                # その他 (10件)
                'ワルファリンカリウム錠1mg「サワイ」', 'ヘパリンナトリウム注射用5000単位「タイヨー」',
                'エノキサパリンナトリウム注射用2000単位「サワイ」', 'ダビガトランエテキシラートメタンスルホン酸塩錠110mg「タイヨー」',
                'リバーロキサバン錠10mg「サワイ」', 'アピキサバン錠2.5mg「タイヨー」',
                'エドキサバントシル酸塩錠30mg「サワイ」', 'フェニトイン錠100mg「タイヨー」',
                'カルバマゼピン錠200mg「サワイ」', 'バルプロ酸ナトリウム錠200mg「タイヨー」',
                # 生活習慣病薬（追加分）
                'オルメサルタンメドキソミル錠20mg「サワイ」',
                'バルサルタン錠80mg「サワイ」',
                'カンデサルタンシレキセチル錠8mg「サワイ」',
                'テルミサルタン錠40mg「サワイ」',
                'アジルサルタン錠20mg「サワイ」',
                'アムロジピンベシル酸塩錠5mg「サワイ」',
                'ニフェジピンCR錠20mg「サワイ」',
                'ベニジピン塩酸塩錠4mg「サワイ」',
                'シルニジピン錠10mg「サワイ」',
                'エナラプリルマレイン酸塩錠5mg「サワイ」',
                'リシノプリル錠10mg「サワイ」',
                'ペリンドプリルエルブミン錠2mg「サワイ」',
                'アリスキレンフマル酸塩錠150mg「サワイ」',
                'ドキサゾシンメシル酸塩錠1mg「サワイ」',
                'プラゾシン塩酸塩錠1mg「サワイ」',
                'メトプロロール酒石酸塩錠20mg「サワイ」',
                'ビソプロロールフマル酸塩錠2.5mg「サワイ」',
                'カルベジロール錠5mg「サワイ」',
                'アトルバスタチンカルシウム錠20mg「サワイ」',
                'ロスバスタチンカルシウム錠5mg「サワイ」',
                'シンバスタチン錠10mg「サワイ」',
                'エゼチミブ錠10mg「サワイ」',
                'フェノフィブラート錠100mg「サワイ」',
                'ベザフィブラート錠200mg「サワイ」',
                'メトホルミン塩酸塩錠500mg「サワイ」',
                'グリベンクラミド錠2.5mg「サワイ」',
                'グリクラジド錠80mg「サワイ」',
                'グリメピリド錠3mg「サワイ」',
                'ピオグリタゾン塩酸塩錠30mg「サワイ」',
                'シタグリプチンリン酸塩錠50mg「サワイ」',
                'リナグリプチン錠10mg「サワイ」',
                'アログリプチン安息香酸塩錠25mg「サワイ」',
                'テネリグリプチン臭化水素酸塩錠40mg「サワイ」'
            ],
            '一般名': [
                # 解熱鎮痛薬
                'アセチルサリチル酸', 'ワルファリンカリウム', 'ロキソプロフェンナトリウム', 'アセトアミノフェン',
                'イブプロフェン', 'ジクロフェナクナトリウム', 'セレコキシブ', 'ナプロキセンナトリウム',
                'メフェナム酸', 'インドメタシン', 'ケトプロフェン', 'フェニルブタゾン',
                'ピロキシカム', 'メロキシカム', 'エトドラク', 'ナブメトン',
                'スリンダク', 'テノキシカム', 'アセメタシン', 'オキサプロジン',
                
                # 循環器系薬
                'ジゴキシン', 'アミオダロン塩酸塩', 'シンバスタチン', 'アトルバスタチンカルシウム',
                'プラバスタチンナトリウム', 'ロスバスタチンカルシウム', 'ピタバスタチンカルシウム', 'フルバスタチンナトリウム',
                'ニフェジピン', 'アムロジピンベシル酸塩', 'ベラパミル塩酸塩', 'ジルチアゼム塩酸塩',
                'カプトプリル', 'エナラプリルマレイン酸塩', 'ロサルタンカリウム',
                
                # 糖尿病治療薬
                'インスリン', 'メトホルミン塩酸塩', 'グリクラジド', 'グリメピリド',
                'ピオグリタゾン塩酸塩', 'シタグリプチンリン酸塩', 'ビルダグリプチン', 'リナグリプチン',
                'アログリプチン安息香酸塩', 'テネリグリプチン臭化水素酸塩',
                
                # 消化器系薬
                'オメプラゾール', 'ランソプラゾール', 'ファモチジン', 'ラニチジン塩酸塩',
                'メトクロプラミド', 'ドンペリドン', 'プルゼニド', 'マグラックス',
                'ピコスルファートナトリウム', 'センノシド', 'ビサコジル', 'ラクツロース',
                'ポリエチレングリコール4000', 'スルピリド', 'イトプリド塩酸塩',
                
                # 抗がん剤
                'エンドキサン', 'オンコビン', 'シスプラチン', 'カルボプラチン',
                'パクリタキセル', 'ドセタキセル', 'イリノテカン塩酸塩', 'オキサリプラチン',
                'ゲムシタビン塩酸塩', 'ビノレルビン酒石酸塩',
                
                # 抗リウマチ薬・免疫抑制薬
                'メトトレキサート', 'プレドニゾロン', 'シクロスポリン', 'タクロリムス',
                'アザチオプリン', 'ミコフェノール酸モフェチル', 'レフルノミド', 'サラゾスルファピリジン',
                'ブシラミン', 'ペニシラミン',
                
                # 抗生物質
                'アモキシシリン', 'セファレキシン', 'エリスロマイシン', 'クラリスロマイシン',
                'アジスロマイシン', 'ドキシサイクリン塩酸塩', 'ミノサイクリン塩酸塩', 'レボフロキサシン',
                'シプロフロキサシン塩酸塩', 'ノルフロキサシン', 'バンコマイシン塩酸塩', 'テイコプラニン',
                'メロペネム', 'イミペネム・シラスタチンナトリウム', 'セフトリアキソンナトリウム',
                
                # 精神神経系薬
                'フルオキセチン塩酸塩', 'パロキセチン塩酸塩', 'セルトラリン塩酸塩', 'エスシタロプラムシュウ酸塩',
                'ベンラファキシン塩酸塩', 'デュロキセチン塩酸塩', 'アリピプラゾール', 'リスペリドン',
                'オランザピン', 'クエチアピンフマル酸塩',
                
                # 呼吸器系薬
                'テオフィリン', 'サルブタモール硫酸塩', 'フォルモテロールフマル酸塩', 'サルメテロールキシナホ酸塩',
                'ブデソニド', 'フルチカゾンプロピオン酸エステル', 'モンテルカストナトリウム', 'ザフィルルカスト',
                'アセチルシステイン', 'カルボシステイン',
                
                # 泌尿器系薬
                'フィナステリド', 'デュタステリド', 'タムスロシン塩酸塩', 'シルドシン',
                'ナフトピジル', 'ウラピジル', 'フロセミド', 'スピロノラクトン',
                'ヒドロクロロチアジド', 'アミロライド塩酸塩',
                
                # その他
                'ワルファリンカリウム', 'ヘパリンナトリウム', 'エノキサパリンナトリウム', 'ダビガトランエテキシラートメタンスルホン酸塩',
                'リバーロキサバン', 'アピキサバン', 'エドキサバントシル酸塩', 'フェニトイン',
                'カルバマゼピン', 'バルプロ酸ナトリウム',
                # 生活習慣病薬（追加分）
                'オルメサルタンメドキソミル',
                'バルサルタン',
                'カンデサルタンシレキセチル',
                'テルミサルタン',
                'アジルサルタン',
                'アムロジピンベシル酸塩',
                'ニフェジピン',
                'ベニジピン塩酸塩',
                'シルニジピン',
                'エナラプリルマレイン酸塩',
                'リシノプリル',
                'ペリンドプリルエルブミン',
                'アリスキレンフマル酸塩',
                'ドキサゾシンメシル酸塩',
                'プラゾシン塩酸塩',
                'メトプロロール酒石酸塩',
                'ビソプロロールフマル酸塩',
                'カルベジロール',
                'アトルバスタチンカルシウム',
                'ロスバスタチンカルシウム',
                'シンバスタチン',
                'エゼチミブ',
                'フェノフィブラート',
                'ベザフィブラート',
                'メトホルミン塩酸塩',
                'グリベンクラミド',
                'グリクラジド',
                'グリメピリド',
                'ピオグリタゾン塩酸塩',
                'シタグリプチンリン酸塩',
                'リナグリプチン',
                'アログリプチン安息香酸塩',
                'テネリグリプチン臭化水素酸塩'
            ],
            '薬効分類': [
                # 解熱鎮痛薬
                '解熱鎮痛薬', '抗凝固薬', '解熱鎮痛薬', '解熱鎮痛薬',
                '解熱鎮痛薬', '解熱鎮痛薬', '解熱鎮痛薬', '解熱鎮痛薬',
                '解熱鎮痛薬', '解熱鎮痛薬', '解熱鎮痛薬', '解熱鎮痛薬',
                '解熱鎮痛薬', '解熱鎮痛薬', '解熱鎮痛薬', '解熱鎮痛薬',
                '解熱鎮痛薬', '解熱鎮痛薬', '解熱鎮痛薬', '解熱鎮痛薬',
                
                # 循環器系薬
                '強心薬', '抗不整脈薬', '脂質異常症治療薬', '脂質異常症治療薬',
                '脂質異常症治療薬', '脂質異常症治療薬', '脂質異常症治療薬', '脂質異常症治療薬',
                'カルシウム拮抗薬', 'カルシウム拮抗薬', 'カルシウム拮抗薬', 'カルシウム拮抗薬',
                'ACE阻害薬', 'ACE阻害薬', 'ARB',
                
                # 糖尿病治療薬
                '糖尿病治療薬', '糖尿病治療薬', '糖尿病治療薬', '糖尿病治療薬',
                '糖尿病治療薬', '糖尿病治療薬', '糖尿病治療薬', '糖尿病治療薬',
                '糖尿病治療薬', '糖尿病治療薬',
                
                # 消化器系薬
                '胃酸分泌抑制薬', '胃酸分泌抑制薬', '胃酸分泌抑制薬', '胃酸分泌抑制薬',
                '制吐薬', '制吐薬', '下剤', '下剤',
                '下剤', '下剤', '下剤', '下剤',
                '下剤', '消化管運動改善薬', '消化管運動改善薬',
                
                # 抗がん剤
                '抗がん剤', '抗がん剤', '抗がん剤', '抗がん剤',
                '抗がん剤', '抗がん剤', '抗がん剤', '抗がん剤',
                '抗がん剤', '抗がん剤',
                
                # 抗リウマチ薬・免疫抑制薬
                '抗リウマチ薬', '副腎皮質ホルモン', '免疫抑制薬', '免疫抑制薬',
                '免疫抑制薬', '免疫抑制薬', '抗リウマチ薬', '抗リウマチ薬',
                '抗リウマチ薬', '抗リウマチ薬',
                
                # 抗生物質
                '抗生物質', '抗生物質', '抗生物質', '抗生物質',
                '抗生物質', '抗生物質', '抗生物質', '抗生物質',
                '抗生物質', '抗生物質', '抗生物質', '抗生物質',
                '抗生物質', '抗生物質', '抗生物質',
                
                # 精神神経系薬
                '抗うつ薬', '抗うつ薬', '抗うつ薬', '抗うつ薬',
                '抗うつ薬', '抗うつ薬', '抗精神病薬', '抗精神病薬',
                '抗精神病薬', '抗精神病薬',
                
                # 呼吸器系薬
                '気管支拡張薬', '気管支拡張薬', '気管支拡張薬', '気管支拡張薬',
                '吸入ステロイド薬', '吸入ステロイド薬', 'ロイコトリエン受容体拮抗薬', 'ロイコトリエン受容体拮抗薬',
                '去痰薬', '去痰薬',
                
                # 泌尿器系薬
                '前立腺肥大症治療薬', '前立腺肥大症治療薬', '前立腺肥大症治療薬', '前立腺肥大症治療薬',
                '前立腺肥大症治療薬', '前立腺肥大症治療薬', '利尿薬', '利尿薬',
                '利尿薬', '利尿薬',
                
                # その他
                '抗凝固薬', '抗凝固薬', '抗凝固薬', '抗凝固薬',
                '抗凝固薬', '抗凝固薬', '抗凝固薬', '抗てんかん薬',
                '抗てんかん薬', '抗てんかん薬',
                # 生活習慣病薬（追加分）
                'ARB', 'ARB', 'ARB', 'ARB', 'ARB',
                'Ca拮抗薬', 'Ca拮抗薬', 'Ca拮抗薬', 'Ca拮抗薬',
                'ACE阻害薬', 'ACE阻害薬', 'ACE阻害薬', 'レニン阻害薬',
                'α遮断薬', 'α遮断薬', 'β遮断薬', 'β遮断薬', 'β遮断薬',
                'スタチン', 'スタチン', 'スタチン', 'コレステロール吸収阻害薬', 'フィブラート', 'フィブラート',
                'ビグアナイド', 'スルホニルウレア', 'スルホニルウレア', 'スルホニルウレア', 'チアゾリジン',
                'DPP-4阻害薬', 'DPP-4阻害薬', 'DPP-4阻害薬', 'DPP-4阻害薬',
            ],
            '相互作用': [
                # 解熱鎮痛薬
                'ワルファリン,抗凝固薬', 'アスピリン,NSAIDs', 'ワルファリン,抗凝固薬', 'ワルファリン,抗凝固薬',
                'ワルファリン,抗凝固薬', 'ワルファリン,抗凝固薬', 'ワルファリン,抗凝固薬', 'ワルファリン,抗凝固薬',
                'ワルファリン,抗凝固薬', 'ワルファリン,抗凝固薬', 'ワルファリン,抗凝固薬', 'ワルファリン,抗凝固薬',
                'ワルファリン,抗凝固薬', 'ワルファリン,抗凝固薬', 'ワルファリン,抗凝固薬', 'ワルファリン,抗凝固薬',
                'ワルファリン,抗凝固薬', 'ワルファリン,抗凝固薬', 'ワルファリン,抗凝固薬', 'ワルファリン,抗凝固薬',
                
                # 循環器系薬
                'アミオダロン,ジゴキシン', 'ジゴキシン,アミオダロン', 'アミオダロン,シンバスタチン', 'シンバスタチン,アミオダロン',
                'アミオダロン,プラバスタチン', 'アミオダロン,ロスバスタチン', 'アミオダロン,ピタバスタチン', 'アミオダロン,フルバスタチン',
                'ジゴキシン,ニフェジピン', 'ジゴキシン,アムロジピン', 'ジゴキシン,ベラパミル', 'ジゴキシン,ジルチアゼム',
                'リチウム,カプトプリル', 'リチウム,エナラプリル', 'リチウム,ロサルタン',
                
                # 糖尿病治療薬
                'インスリン,メトホルミン', 'メトホルミン,インスリン', 'ワルファリン,グリクラジド', 'ワルファリン,グリメピリド',
                'ワルファリン,ピオグリタゾン', 'ワルファリン,シタグリプチン', 'ワルファリン,ビルダグリプチン', 'ワルファリン,リナグリプチン',
                'ワルファリン,アログリプチン', 'ワルファリン,テネリグリプチン',
                
                # 消化器系薬
                'オメプラゾール,鉄剤', 'ランソプラゾール,鉄剤', 'ファモチジン,鉄剤', 'ラニチジン,鉄剤',
                'メトクロプラミド,パーキンソン病治療薬', 'ドンペリドン,パーキンソン病治療薬', 'プルゼニド,ジゴキシン', 'マグラックス,制吐薬',
                'ピコスルファート,下剤', 'センノシド,下剤', 'ビサコジル,下剤', 'ラクツロース,下剤',
                'ポリエチレングリコール,下剤', 'スルピリド,パーキンソン病治療薬', 'イトプリド,パーキンソン病治療薬',
                
                # 抗がん剤
                'エンドキサン,制吐薬', 'オンコビン,制吐薬', 'シスプラチン,制吐薬', 'カルボプラチン,制吐薬',
                'パクリタキセル,制吐薬', 'ドセタキセル,制吐薬', 'イリノテカン,制吐薬', 'オキサリプラチン,制吐薬',
                'ゲムシタビン,制吐薬', 'ビノレルビン,制吐薬',
                
                # 抗リウマチ薬・免疫抑制薬
                'メトトレキサート,葉酸', 'プレドニゾロン,インスリン', 'シクロスポリン,スタチン', 'タクロリムス,スタチン',
                'アザチオプリン,アロプリノール', 'ミコフェノール酸,制酸剤', 'レフルノミド,メトトレキサート', 'サラゾスルファピリジン,葉酸',
                'ブシラミン,金製剤', 'ペニシラミン,金製剤',
                
                # 抗生物質
                'ワルファリン,アモキシシリン', 'ワルファリン,セファレキシン', 'ワルファリン,エリスロマイシン', 'ワルファリン,クラリスロマイシン',
                'ワルファリン,アジスロマイシン', 'ワルファリン,ドキシサイクリン', 'ワルファリン,ミノサイクリン', 'ワルファリン,レボフロキサシン',
                'ワルファリン,シプロフロキサシン', 'ワルファリン,ノルフロキサシン', 'ワルファリン,バンコマイシン', 'ワルファリン,テイコプラニン',
                'ワルファリン,メロペネム', 'ワルファリン,イミペネム', 'ワルファリン,セフトリアキソン',
                
                # 精神神経系薬
                'ワルファリン,フルオキセチン', 'ワルファリン,パロキセチン', 'ワルファリン,セルトラリン', 'ワルファリン,エスシタロプラム',
                'ワルファリン,ベンラファキシン', 'ワルファリン,デュロキセチン', 'ワルファリン,アリピプラゾール', 'ワルファリン,リスペリドン',
                'ワルファリン,オランザピン', 'ワルファリン,クエチアピン',
                
                # 呼吸器系薬
                'ワルファリン,テオフィリン', 'ワルファリン,サルブタモール', 'ワルファリン,フォルモテロール', 'ワルファリン,サルメテロール',
                'ワルファリン,ブデソニド', 'ワルファリン,フルチカゾン', 'ワルファリン,モンテルカスト', 'ワルファリン,ザフィルルカスト',
                'ワルファリン,アセチルシステイン', 'ワルファリン,カルボシステイン',
                
                # 泌尿器系薬
                'ワルファリン,フィナステリド', 'ワルファリン,デュタステリド', 'ワルファリン,タムスロシン', 'ワルファリン,シルドシン',
                'ワルファリン,ナフトピジル', 'ワルファリン,ウラピジル', 'ワルファリン,フロセミド', 'ワルファリン,スピロノラクトン',
                'ワルファリン,ヒドロクロロチアジド', 'ワルファリン,アミロライド',
                
                # その他
                'アスピリン,NSAIDs', 'ワルファリン,ヘパリン', 'ワルファリン,エノキサパリン', 'ワルファリン,ダビガトラン',
                'ワルファリン,リバーロキサバン', 'ワルファリン,アピキサバン', 'ワルファリン,エドキサバン', 'ワルファリン,フェニトイン',
                'ワルファリン,カルバマゼピン', 'ワルファリン,バルプロ酸',
                # 生活習慣病薬（追加分）
                'カリウム保持性利尿薬,NSAIDs', 'カリウム保持性利尿薬,NSAIDs', 'カリウム保持性利尿薬,NSAIDs', 'カリウム保持性利尿薬,NSAIDs', 'カリウム保持性利尿薬,NSAIDs',
                'グレープフルーツジュース', 'グレープフルーツジュース', 'グレープフルーツジュース', 'グレープフルーツジュース',
                'NSAIDs', 'NSAIDs', 'NSAIDs', 'シクロスポリン',
                '他の降圧薬', '他の降圧薬', 'CYP2D6阻害薬', 'CYP2D6阻害薬', 'CYP2D6阻害薬',
                'シクロスポリン', 'シクロスポリン', 'シクロスポリン', 'コレスチラミン', 'ワルファリン', 'ワルファリン',
                'アルコール', 'ワルファリン', 'ワルファリン', 'ワルファリン', 'インスリン',
                'CYP3A4阻害薬', 'CYP3A4阻害薬', 'CYP3A4阻害薬', 'CYP3A4阻害薬',
            ]
        }
        return pd.DataFrame(sample_data)
    
    def _process_drug_data(self, df):
        """薬剤データを処理して統一フォーマットに変換"""
        try:
            # カラム名を英語に変換
            processed_df = df.copy()
            processed_df.columns = ['drug_name', 'generic_name', 'category', 'interactions']
            
            # データのクリーニング
            processed_df = processed_df.dropna()
            
            # 相互作用データの正規化
            processed_df['interactions'] = processed_df['interactions'].fillna('')
            
            logger.info(f"データ処理完了: {len(processed_df)}件")
            return processed_df
            
        except Exception as e:
            logger.error(f"データ処理エラー: {e}")
            return self._create_fallback_data()
    
    def _create_fallback_data(self):
        """フォールバック用のサンプルデータ"""
        fallback_data = {
            'drug_name': ['アスピリン', 'ワルファリン', 'ジゴキシン'],
            'generic_name': ['アセチルサリチル酸', 'ワルファリンカリウム', 'ジゴキシン'],
            'category': ['解熱鎮痛薬', '抗凝固薬', '強心薬'],
            'interactions': ['ワルファリン,抗凝固薬', 'アスピリン,NSAIDs', 'アミオダロン,ジゴキシン']
        }
        return pd.DataFrame(fallback_data) 